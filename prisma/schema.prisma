generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String      @id @default(cuid())
  workosId          String      @unique @map("workos_id")
  email             String      @unique
  firstName         String      @map("first_name")
  lastName          String      @map("last_name")
  role              UserRole    @default(CONCIERGE)
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  emailVerified     Boolean     @default(false) @map("email_verified")
  lastLogin         DateTime?   @map("last_login")
  status            UserStatus  @default(ACTIVE)
  createdPatients   Patient[]   @relation("PatientCreatedBy")
  updatedPatients   Patient[]   @relation("PatientUpdatedBy")
  createdPractices  Practice[]  @relation("PracticeCreatedBy")
  createdProcedures Procedure[] @relation("ProcedureCreatedBy")
  updatedProcedures Procedure[] @relation("ProcedureUpdatedBy")

  @@map("users")
}

model EmrCredential {
  id                       String      @id @default(uuid()) @db.Uuid
  provider                 EmrProvider
  ownerId                  String      @map("owner_id") @db.Uuid
  ownerType                OwnerType   @default(USER) @map("owner_type")
  label                    String?     @db.VarChar(100)
  encryptedData            String      @map("encrypted_data")
  fingerprint              String      @unique @db.VarChar(128)
  isValid                  Boolean     @default(false) @map("is_valid")
  lastValidatedAt          DateTime?   @map("last_validated_at")
  validationError          String?     @map("validation_error")
  createdAt                DateTime    @default(now()) @map("created_at")
  updatedAt                DateTime    @updatedAt @map("updated_at")
  locationId               String?     @map("location_id") @db.VarChar(100)
  mindbodyLocationId       String?     @map("mindbody_location_id") @db.VarChar(50)
  mindbodySessionTypeId    String?     @map("mindbody_session_type_id") @db.VarChar(50)
  mindbodyStaffId          String?     @map("mindbody_staff_id") @db.VarChar(50)
  nextechProviderId        String?     @map("nextech_provider_id") @db.VarChar(50)
  nextechLocationId        String?     @map("nextech_location_id") @db.VarChar(50)
  nextechAppointmentTypeId String?     @map("nextech_appointment_type_id") @db.VarChar(50)
  modmedProviderId         String?     @map("modmed_provider_id") @db.VarChar(50)
  modmedLocationId         String?     @map("modmed_location_id") @db.VarChar(50)
  modmedAppointmentTypeId  String?     @map("modmed_appointment_type_id") @db.VarChar(50)

  @@map("emr_credentials")
}

model Patient {
  id                        String               @id @default(uuid()) @db.Uuid
  dob                       DateTime             @map("dob") @db.Date
  email                     String               @unique @db.VarChar(255)
  phone                     String?              @db.VarChar(25)
  notes                     String?
  createdAt                 DateTime             @default(now()) @map("created_at")
  updatedAt                 DateTime             @updatedAt @map("updated_at")
  consentFormsSigned        Boolean?             @default(false) @map("consent_forms_signed")
  privacyNoticeAcknowledged Boolean?             @default(false) @map("privacy_notice_acknowledged")
  createdBy                 String               @map("created_by")
  updatedBy                 String               @map("updated_by")
  addressLine1              String?              @map("address_line1") @db.VarChar(255)
  city                      String?              @db.VarChar(100)
  postalCode                String?              @map("postal_code") @db.VarChar(20)
  state                     String?              @db.VarChar(50)
  amReferralId              String?              @unique @map("am_referral_id") @db.VarChar(100)
  gender                    PatientGender?       @map("gender")
  firstName                 String               @map("first_name") @db.VarChar(100)
  lastName                  String               @map("last_name") @db.VarChar(155)
  nextechPatientId          String?              @map("nextech_patient_id") @db.VarChar(100)
  modmedPatientId           String?              @map("modmed_patient_id") @db.VarChar(100)
  appointments              Appointment[]
  allergies                 PatientAllergy[]
  healthFlags               PatientHealthFlag[]
  medications               PatientMedication[]
  pastSurgeries             PatientPastSurgery[]
  createdByUser             User                 @relation("PatientCreatedBy", fields: [createdBy], references: [id])
  updatedByUser             User                 @relation("PatientUpdatedBy", fields: [updatedBy], references: [id])

  @@index([nextechPatientId], map: "idx_patients_nextech_patient_id")
  @@map("patients")
}

model PatientPastSurgery {
  id          String    @id @default(uuid()) @db.Uuid
  patientId   String    @map("patient_id") @db.Uuid
  surgeryType String    @map("surgery_type") @db.VarChar(100)
  surgeryDate DateTime? @map("surgery_date") @db.Date
  details     String?
  createdAt   DateTime  @default(now()) @map("created_at")
  patient     Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("patient_past_surgeries")
}

model PatientAllergy {
  id          String          @id @default(uuid()) @db.Uuid
  patientId   String          @map("patient_id") @db.Uuid
  allergyName String          @map("allergy_name") @db.VarChar(100)
  severity    AllergySeverity @default(mild)
  details     String?
  createdAt   DateTime        @default(now()) @map("created_at")
  patient     Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("patient_allergies")
}

model PatientMedication {
  id             String   @id @default(uuid()) @db.Uuid
  patientId      String   @map("patient_id") @db.Uuid
  medicationName String   @map("medication_name") @db.VarChar(100)
  dosage         String?  @db.VarChar(50)
  frequency      String?  @db.VarChar(50)
  details        String?
  createdAt      DateTime @default(now()) @map("created_at")
  patient        Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("patient_medications")
}

model PatientHealthFlag {
  id        String   @id @default(uuid()) @db.Uuid
  patientId String   @map("patient_id") @db.Uuid
  flagKey   String   @map("flag_key") @db.VarChar(50)
  flagValue Boolean  @map("flag_value")
  details   String?
  createdAt DateTime @default(now()) @map("created_at")
  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("patient_health_flags")
}

model Procedure {
  id              String            @id @default(uuid()) @db.Uuid
  name            String            @db.VarChar(255)
  category        ProcedureCategory
  defaultFeeRule  FeeRule           @map("default_fee_rule")
  feeAmount       Decimal           @map("fee_amount") @db.Decimal(10, 2)
  linkedPractices String[]          @map("linked_practices") @db.Uuid
  createdBy       String            @map("created_by")
  updatedBy       String?           @map("updated_by")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  createdByUser   User              @relation("ProcedureCreatedBy", fields: [createdBy], references: [id])
  updatedByUser   User?             @relation("ProcedureUpdatedBy", fields: [updatedBy], references: [id])

  @@map("procedures")
}

model Practice {
  id             String                 @id @default(uuid()) @db.Uuid
  name           String                 @db.VarChar(255)
  emrType        String?                @map("emr_type") @db.VarChar(50)
  createdAt      DateTime               @default(now()) @map("created_at")
  createdBy      String                 @map("created_by")
  appointments   Appointment[]
  availabilities PracticeAvailability[]
  createdByUser  User                   @relation("PracticeCreatedBy", fields: [createdBy], references: [id])
  serviceFees    ServiceFee[]

  @@map("practices")
}

model PracticeAvailability {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  practiceId    String   @map("practice_id") @db.Uuid
  startDateTime DateTime @map("start_date_time")
  endDateTime   DateTime @map("end_date_time")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  practice      Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@map("practice_availabilities")
}

model ServiceFee {
  id           String        @id @default(uuid()) @db.Uuid
  practiceId   String        @map("practice_id") @db.Uuid
  serviceName  String        @map("service_name") @db.VarChar(255)
  price        Decimal       @db.Decimal(10, 2)
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  serviceType  ServiceType   @default(consult) @map("service_type")
  appointments Appointment[] @relation("ServiceFeeAppointments")
  practice     Practice      @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@unique([id, practiceId])
  @@map("service_fees")
}

model Appointment {
  id               String            @id @default(uuid()) @db.Uuid
  patientId        String            @map("patient_id") @db.Uuid
  practiceId       String            @map("practice_id") @db.Uuid
  appointmentType  AppointmentType   @map("appointment_type")
  status           AppointmentStatus @map("status")
  date             DateTime          @db.Timestamp(6)
  isReturnVisit    Boolean           @default(false) @map("is_return_visit")
  emrAppointmentId String?           @map("emr_appointment_id") @db.VarChar(100)
  createdAt        DateTime          @default(now()) @map("created_at")
  serviceFeeId     String?           @map("service_fee_id") @db.Uuid
  serviceName      String?           @map("service_name") @db.VarChar(255)
  serviceType      ServiceType?      @map("service_type")
  servicePrice     Decimal?          @map("service_price") @db.Decimal(10, 2)
  feeAmount        Decimal?          @map("fee_amount") @db.Decimal(10, 2)
  mode             AppointmentMode   @default(in_person) @map("mode")
  patient          Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  practice         Practice          @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  serviceFee       ServiceFee?       @relation("ServiceFeeAppointments", fields: [serviceFeeId, practiceId], references: [id, practiceId])

  @@map("appointments")
}

model FeeSettings {
  id             String   @id @default(uuid()) @db.Uuid
  consultFee     Decimal  @db.Decimal(10, 2)
  surgeryFee     Decimal  @db.Decimal(10, 2)
  nonSurgicalFee Decimal  @db.Decimal(10, 2)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("fee_settings")
}

enum UserRole {
  CONCIERGE
  OPS_FINANCE
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum PatientGender {
  MALE
  FEMALE
}

enum EmrProvider {
  MINDBODY
  NEXTECH
  MODMED
  PATIENTNOW
}

enum OwnerType {
  PRACTICE
  USER
}

enum AllergySeverity {
  mild
  moderate
  severe
}

enum ProcedureCategory {
  SURGICAL
  NON_SURGICAL
}

enum FeeRule {
  TIER_A
  TIER_B
  CONSULT
  SURGERY
}

enum AppointmentType {
  first_visit
  repeat_visit
  surgical_consult
  surgery
}

enum AppointmentStatus {
  booked
  completed
  canceled
  expired
}

enum AppointmentMode {
  virtual
  in_person
}

enum ServiceType {
  consult
  surgery
  non_surgical
}
