generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String     @id @default(cuid())
  workosId     String     @unique @map("workos_id")
  email        String     @unique
  firstName    String     @map("first_name")
  lastName     String     @map("last_name")
  role         UserRole   @default(CONCIERGE)
  status       UserStatus @default(ACTIVE)
  emailVerified Boolean   @default(false) @map("email_verified")
  lastLogin    DateTime?  @map("last_login")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  createdPatients Patient[] @relation("PatientCreatedBy")
  updatedPatients Patient[] @relation("PatientUpdatedBy")
  createdProcedures Procedure[] @relation("ProcedureCreatedBy")
  updatedProcedures Procedure[] @relation("ProcedureUpdatedBy")
  createdPractices Practice[] @relation("PracticeCreatedBy")

  @@map("users")
}

enum UserRole {
  CONCIERGE
  OPS_FINANCE
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum EmrProvider {
  MINDBODY
  NEXTECH
  MODMED
  PATIENTNOW
}

enum OwnerType {
  PRACTICE
  USER
}

model EmrCredential {
  id                 String      @id @default(uuid()) @db.Uuid
  provider           EmrProvider
  ownerId            String      @map("owner_id") @db.Uuid
  ownerType          OwnerType   @map("owner_type") @default(USER)
  label              String?     @db.VarChar(100)
  encryptedData      String      @map("encrypted_data") @db.Text
  fingerprint        String      @unique @db.VarChar(128)
  isValid            Boolean     @default(false) @map("is_valid")
  lastValidatedAt    DateTime?   @map("last_validated_at")
  validationError    String?     @map("validation_error") @db.Text
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  @@map("emr_credentials")
}

model Patient {
  id                        String    @id @default(uuid()) @db.Uuid
  name                      String    @db.VarChar(255)
  dob                       DateTime  @map("dob") @db.Date
  email                     String    @unique @db.VarChar(255)
  phone                     String?   @db.VarChar(25)
  notes                     String?   @db.Text
  addressLine1              String?   @map("address_line1") @db.VarChar(255)
  city                      String?   @db.VarChar(100)
  state                     String?   @db.VarChar(50)
  postalCode                String?   @map("postal_code") @db.VarChar(20)
  consentFormsSigned        Boolean?  @default(false) @map("consent_forms_signed")
  privacyNoticeAcknowledged Boolean?  @default(false) @map("privacy_notice_acknowledged")
  createdBy                 String    @map("created_by")
  updatedBy                 String    @map("updated_by")
  createdAt                 DateTime  @default(now()) @map("created_at")
  updatedAt                 DateTime  @updatedAt @map("updated_at")

  // Relations
  createdByUser User @relation("PatientCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User @relation("PatientUpdatedBy", fields: [updatedBy], references: [id])
  pastSurgeries PatientPastSurgery[]
  allergies PatientAllergy[]
  medications PatientMedication[]
  healthFlags PatientHealthFlag[]

  appointments Appointment[]

  @@map("patients")
}

model PatientPastSurgery {
  id          String    @id @default(uuid()) @db.Uuid
  patientId   String    @map("patient_id") @db.Uuid
  surgeryType String    @map("surgery_type") @db.VarChar(100)
  surgeryDate DateTime? @map("surgery_date") @db.Date
  details     String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("patient_past_surgeries")
}

enum AllergySeverity {
  mild
  moderate
  severe
}

model PatientAllergy {
  id          String          @id @default(uuid()) @db.Uuid
  patientId   String          @map("patient_id") @db.Uuid
  allergyName String          @map("allergy_name") @db.VarChar(100)
  severity    AllergySeverity @default(mild)
  details     String?         @db.Text
  createdAt   DateTime        @default(now()) @map("created_at")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("patient_allergies")
}

model PatientMedication {
  id             String   @id @default(uuid()) @db.Uuid
  patientId      String   @map("patient_id") @db.Uuid
  medicationName String   @map("medication_name") @db.VarChar(100)
  dosage         String?  @db.VarChar(50)
  frequency      String?  @db.VarChar(50)
  details        String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("patient_medications")
}

model PatientHealthFlag {
  id        String   @id @default(uuid()) @db.Uuid
  patientId String   @map("patient_id") @db.Uuid
  flagKey   String   @map("flag_key") @db.VarChar(50)
  flagValue Boolean  @map("flag_value")
  details   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("patient_health_flags")
}

enum ProcedureCategory {
  SURGICAL
  NON_SURGICAL
}

enum FeeRule {
  TIER_A
  TIER_B
  CONSULT
  SURGERY
}

model Procedure {
  id             String            @id @default(uuid()) @db.Uuid
  name           String            @db.VarChar(255)
  category       ProcedureCategory
  defaultFeeRule FeeRule           @map("default_fee_rule")
  feeAmount      Decimal           @map("fee_amount") @db.Decimal(10, 2)
  linkedPractices String[]         @map("linked_practices") @db.Uuid
  createdBy      String            @map("created_by")
  updatedBy      String?           @map("updated_by")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  // Relations
  createdByUser User @relation("ProcedureCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User? @relation("ProcedureUpdatedBy", fields: [updatedBy], references: [id])

  @@map("procedures")
}

model Practice {
  id               String   @id @default(uuid()) @db.Uuid
  name             String   @db.VarChar(255)
  emrType          String?  @map("emr_type") @db.VarChar(50)
  connectorConfig  String?  @map("connector_config") @db.Text
  feeModel         String?  @map("fee_model") @db.Text
  createdAt        DateTime @default(now()) @map("created_at")
  createdBy        String   @map("created_by")

  // Relations
  createdByUser    User     @relation("PracticeCreatedBy", fields: [createdBy], references: [id])
  appointments     Appointment[]
  serviceFees      ServiceFee[]

  @@map("practices")
}

model ServiceFee {
  id           String   @id @default(uuid()) @db.Uuid
  practiceId   String   @map("practice_id") @db.Uuid
  serviceName  String   @map("service_name") @db.VarChar(255)
  serviceType  ServiceType @map("service_type") @default(consult)
  price        Decimal  @db.Decimal(10, 2)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  practice     Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@map("service_fees")
}

enum AppointmentType {
  first_visit
  repeat_visit
  surgical_consult
  surgery
}

enum AppointmentStatus {
  booked
  completed
  canceled
  expired
}

model Appointment {
  id                String            @id @default(uuid()) @db.Uuid
  patientId         String            @map("patient_id") @db.Uuid
  practiceId        String            @map("practice_id") @db.Uuid
  appointmentType   AppointmentType   @map("appointment_type")
  status            AppointmentStatus @map("status")
  date              DateTime          @db.Timestamp(6)
  isReturnVisit     Boolean           @default(false) @map("is_return_visit")
  emrAppointmentId  String?           @map("emr_appointment_id") @db.VarChar(100)
  createdAt         DateTime          @default(now()) @map("created_at")

  // Relations
  patient           Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  practice          Practice          @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@map("appointments")
}

// Global fee settings for consult, surgery, and non-surgical.
model FeeSettings {
  id               String   @id @default(uuid()) @db.Uuid
  consultFee       Decimal  @db.Decimal(10, 2)
  surgeryFee       Decimal  @db.Decimal(10, 2)
  nonSurgicalFee   Decimal  @db.Decimal(10, 2)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("fee_settings")
}

// Service type for practice-defined services
enum ServiceType {
  consult
  surgery
  non_surgical
}
